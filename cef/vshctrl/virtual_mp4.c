#include <strings.h>
#include "utils.h"

#include <string.h>
#include <stdio.h>
#include <stdlib.h>

#include <pspsdk.h>
#include <pspctrl.h>
#include <systemctrl.h>
#include <systemctrl_se.h>
#include <vshctrl.h>
#include <common.h>
#include "isoreader.h"
#include "dirent_track.h"

int vshDetectDiscType(const char *path);

static unsigned char smallvid[] __attribute__((aligned(16))) = {
	0x00, 0x00, 0x00, 0x1c, 0x66, 0x74, 0x79, 0x70, 0x4d, 0x53, 0x4e, 0x56, 0x01, 0x2a, 0x00, 0x7e,
	0x4d, 0x53, 0x4e, 0x56, 0x6d, 0x70, 0x34, 0x32, 0x69, 0x73, 0x6f, 0x6d, 0x00, 0x00, 0x00, 0x94,
	0x75, 0x75, 0x69, 0x64, 0x50, 0x52, 0x4f, 0x46, 0x21, 0xd2, 0x4f, 0xce, 0xbb, 0x88, 0x69, 0x5c,
	0xfa, 0xc9, 0xc7, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x14,
	0x46, 0x50, 0x52, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x2c, 0x41, 0x50, 0x52, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
	0x6d, 0x70, 0x34, 0x61, 0x00, 0x00, 0x02, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
	0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0xbb, 0x80, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x34,
	0x56, 0x50, 0x52, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x61, 0x76, 0x63, 0x31,
	0x01, 0x4d, 0x40, 0x15, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x07, 0x80,
	0x00, 0x1d, 0xf8, 0x54, 0x00, 0x1d, 0xf8, 0x54, 0x01, 0x40, 0x00, 0xf0, 0x00, 0x01, 0x00, 0x01,
	0x00, 0x00, 0x00, 0x08, 0x66, 0x72, 0x65, 0x65, 0x00, 0x00, 0x09, 0x7f, 0x6d, 0x6f, 0x6f, 0x76,
	0x00, 0x00, 0x00, 0x6c, 0x6d, 0x76, 0x68, 0x64, 0x00, 0x00, 0x00, 0x00, 0xe4, 0x25, 0xdc, 0x98,
	0xe4, 0x25, 0xdc, 0x98, 0x00, 0x01, 0x5f, 0x90, 0x00, 0x00, 0x8e, 0x80, 0x00, 0x01, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x02, 0x6f,
	0x74, 0x72, 0x61, 0x6b, 0x00, 0x00, 0x00, 0x5c, 0x74, 0x6b, 0x68, 0x64, 0x00, 0x00, 0x00, 0x07,
	0xe4, 0x25, 0xdc, 0x98, 0xe4, 0x25, 0xdc, 0x98, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x8e, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x24, 0x65, 0x64, 0x74, 0x73, 0x00, 0x00, 0x00, 0x1c, 0x65, 0x6c, 0x73, 0x74,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x8e, 0x80, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0xb3, 0x6d, 0x64, 0x69, 0x61, 0x00, 0x00, 0x00, 0x20,
	0x6d, 0x64, 0x68, 0x64, 0x00, 0x00, 0x00, 0x00, 0xe4, 0x25, 0xdc, 0x98, 0xe4, 0x25, 0xdc, 0x98,
	0x00, 0x00, 0xbb, 0x80, 0x00, 0x00, 0x4c, 0x00, 0x15, 0xc7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34,
	0x68, 0x64, 0x6c, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x73, 0x6f, 0x75, 0x6e,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x53, 0x6f, 0x75, 0x6e,
	0x64, 0x20, 0x4d, 0x65, 0x64, 0x69, 0x61, 0x20, 0x48, 0x61, 0x6e, 0x64, 0x6c, 0x65, 0x72, 0x00,
	0x00, 0x00, 0x01, 0x57, 0x6d, 0x69, 0x6e, 0x66, 0x00, 0x00, 0x00, 0x10, 0x73, 0x6d, 0x68, 0x64,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x64, 0x69, 0x6e, 0x66,
	0x00, 0x00, 0x00, 0x1c, 0x64, 0x72, 0x65, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
	0x00, 0x00, 0x00, 0x0c, 0x75, 0x72, 0x6c, 0x20, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x1b,
	0x73, 0x74, 0x62, 0x6c, 0x00, 0x00, 0x00, 0x5b, 0x73, 0x74, 0x73, 0x64, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x4b, 0x6d, 0x70, 0x34, 0x61, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x10,
	0x00, 0x00, 0x00, 0x00, 0xbb, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x27, 0x65, 0x73, 0x64, 0x73,
	0x00, 0x00, 0x00, 0x00, 0x03, 0x19, 0x00, 0x00, 0x00, 0x04, 0x11, 0x40, 0x15, 0x00, 0x06, 0x00,
	0x00, 0x01, 0xf4, 0x00, 0x00, 0x01, 0xf4, 0x00, 0x05, 0x02, 0x11, 0x90, 0x06, 0x01, 0x02, 0x00,
	0x00, 0x00, 0x18, 0x73, 0x74, 0x74, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
	0x00, 0x00, 0x13, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x28, 0x73, 0x74, 0x73, 0x63, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x10, 0x00,
	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00,
	0x00, 0x00, 0x60, 0x73, 0x74, 0x73, 0x7a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x13, 0x00, 0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x55, 0x00,
	0x00, 0x01, 0x56, 0x00, 0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x56, 0x00,
	0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x56, 0x00, 0x00, 0x01, 0x55, 0x00,
	0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x56, 0x00, 0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x55, 0x00,
	0x00, 0x01, 0x56, 0x00, 0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x55, 0x00, 0x00, 0x01, 0x56, 0x00,
	0x00, 0x00, 0x18, 0x73, 0x74, 0x63, 0x6f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00,
	0x00, 0x64, 0x7c, 0x00, 0x00, 0x79, 0xf6, 0x00, 0x00, 0x00, 0x34, 0x75, 0x75, 0x69, 0x64, 0x55,
	0x53, 0x4d, 0x54, 0x21, 0xd2, 0x4f, 0xce, 0xbb, 0x88, 0x69, 0x5c, 0xfa, 0xc9, 0xc7, 0x40, 0x00,
	0x00, 0x00, 0x1c, 0x4d, 0x54, 0x44, 0x54, 0x00, 0x01, 0x00, 0x12, 0x00, 0x00, 0x00, 0x0a, 0x55,
	0xc4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1a, 0x74,
	0x72, 0x61, 0x6b, 0x00, 0x00, 0x00, 0x5c, 0x74, 0x6b, 0x68, 0x64, 0x00, 0x00, 0x00, 0x07, 0xe4,
	0x25, 0xdc, 0x98, 0xe4, 0x25, 0xdc, 0x98, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x81, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x01, 0x40, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x24, 0x65, 0x64, 0x74, 0x73, 0x00, 0x00, 0x00, 0x1c, 0x65, 0x6c, 0x73, 0x74, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x81, 0x09, 0x00, 0x00, 0x03, 0xe9, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x00, 0x02, 0x5e, 0x6d, 0x64, 0x69, 0x61, 0x00, 0x00, 0x00, 0x20, 0x6d,
	0x64, 0x68, 0x64, 0x00, 0x00, 0x00, 0x00, 0xe4, 0x25, 0xdc, 0x98, 0xe4, 0x25, 0xdc, 0x98, 0x00,
	0x00, 0x75, 0x30, 0x00, 0x00, 0x2b, 0x03, 0x15, 0xc7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x68,
	0x64, 0x6c, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x69, 0x64, 0x65, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x56, 0x69, 0x64, 0x65, 0x6f,
	0x20, 0x4d, 0x65, 0x64, 0x69, 0x61, 0x20, 0x48, 0x61, 0x6e, 0x64, 0x6c, 0x65, 0x72, 0x00, 0x00,
	0x00, 0x02, 0x02, 0x6d, 0x69, 0x6e, 0x66, 0x00, 0x00, 0x00, 0x14, 0x76, 0x6d, 0x68, 0x64, 0x00,
	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x64,
	0x69, 0x6e, 0x66, 0x00, 0x00, 0x00, 0x1c, 0x64, 0x72, 0x65, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0c, 0x75, 0x72, 0x6c, 0x20, 0x00, 0x00, 0x00, 0x01, 0x00,
	0x00, 0x01, 0xc2, 0x73, 0x74, 0x62, 0x6c, 0x00, 0x00, 0x00, 0xa6, 0x73, 0x74, 0x73, 0x64, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x96, 0x61, 0x76, 0x63, 0x31, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x40, 0x00, 0xf0, 0x00, 0x48, 0x00, 0x00, 0x00,
	0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0a, 0x41, 0x56, 0x43, 0x20, 0x43, 0x6f,
	0x64, 0x69, 0x6e, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xff, 0xff, 0x00, 0x00, 0x00,
	0x40, 0x61, 0x76, 0x63, 0x43, 0x01, 0x4d, 0x40, 0x15, 0xff, 0xe1, 0x00, 0x29, 0x27, 0x4d, 0x40,
	0x15, 0x97, 0x60, 0xa0, 0xfd, 0x80, 0x88, 0x00, 0x00, 0x7d, 0x20, 0x00, 0x1d, 0x4c, 0x07, 0x45,
	0x00, 0xbb, 0x80, 0x02, 0x49, 0xf5, 0xef, 0x70, 0x68, 0x80, 0x17, 0x70, 0x00, 0x7a, 0x12, 0xbd,
	0xee, 0x07, 0x68, 0x22, 0x11, 0x4e, 0x01, 0x00, 0x04, 0x28, 0xee, 0x3c, 0x80, 0x00, 0x00, 0x00,
	0x18, 0x73, 0x74, 0x74, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
	0x0b, 0x00, 0x00, 0x03, 0xe9, 0x00, 0x00, 0x00, 0x68, 0x63, 0x74, 0x74, 0x73, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x03, 0xe9, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x07, 0xd2, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x07, 0xd2, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x07, 0xd2, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x07, 0xd2, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x07, 0xd2, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x28, 0x73, 0x74, 0x73, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x40, 0x73, 0x74, 0x73, 0x7a, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x75, 0x00, 0x00, 0x00,
	0x26, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00, 0x00,
	0x25, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00, 0x00,
	0x25, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x18, 0x73, 0x74, 0x63, 0x6f, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x62, 0xb9, 0x00, 0x00, 0x79, 0xd1, 0x00, 0x00, 0x00,
	0x14, 0x73, 0x74, 0x73, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x34, 0x75, 0x75, 0x69, 0x64, 0x55, 0x53, 0x4d, 0x54, 0x21, 0xd2, 0x4f,
	0xce, 0xbb, 0x88, 0x69, 0x5c, 0xfa, 0xc9, 0xc7, 0x40, 0x00, 0x00, 0x00, 0x1c, 0x4d, 0x54, 0x44,
	0x54, 0x00, 0x01, 0x00, 0x12, 0x00, 0x00, 0x00, 0x0a, 0x55, 0xc4, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x82, 0x75, 0x75, 0x69, 0x64, 0x55, 0x53, 0x4d,
	0x54, 0x21, 0xd2, 0x4f, 0xce, 0xbb, 0x88, 0x69, 0x5c, 0xfa, 0xc9, 0xc7, 0x40, 0x00, 0x00, 0x02,
	0x94, 0x4d, 0x54, 0x44, 0x54, 0x00, 0x0a, 0x00, 0x3a, 0x00, 0x00, 0x00, 0x01, 0x95, 0xc7, 0x00,
	0x01, 0x00, 0x59, 0x00, 0x6f, 0x00, 0x75, 0x00, 0x72, 0x00, 0x20, 0x00, 0x67, 0x00, 0x75, 0x00,
	0x69, 0x00, 0x64, 0x00, 0x65, 0x00, 0x20, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x20, 0x00, 0x64, 0x00,
	0x6f, 0x00, 0x77, 0x00, 0x6e, 0x00, 0x6c, 0x00, 0x6f, 0x00, 0x61, 0x00, 0x64, 0x00, 0x73, 0x00,
	0x00, 0x00, 0x54, 0x00, 0x00, 0x00, 0x01, 0x9a, 0x41, 0x00, 0x01, 0x00, 0x56, 0x00, 0x6f, 0x00,
	0x74, 0x00, 0x72, 0x00, 0x65, 0x00, 0x20, 0x00, 0x67, 0x00, 0x75, 0x00, 0x69, 0x00, 0x64, 0x00,
	0x65, 0x00, 0x20, 0x00, 0x70, 0x00, 0x6f, 0x00, 0x75, 0x00, 0x72, 0x00, 0x20, 0x00, 0x6c, 0x00,
	0x65, 0x00, 0x73, 0x00, 0x20, 0x00, 0x74, 0x00, 0xe9, 0x00, 0x6c, 0x00, 0xe9, 0x00, 0x63, 0x00,
	0x68, 0x00, 0x61, 0x00, 0x72, 0x00, 0x67, 0x00, 0x65, 0x00, 0x6d, 0x00, 0x65, 0x00, 0x6e, 0x00,
	0x74, 0x00, 0x73, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x01, 0xa6, 0x81, 0x00, 0x01, 0x00,
	0x4c, 0x00, 0x61, 0x00, 0x20, 0x00, 0x74, 0x00, 0x75, 0x00, 0x61, 0x00, 0x20, 0x00, 0x67, 0x00,
	0x75, 0x00, 0x69, 0x00, 0x64, 0x00, 0x61, 0x00, 0x20, 0x00, 0x61, 0x00, 0x69, 0x00, 0x20, 0x00,
	0x64, 0x00, 0x6f, 0x00, 0x77, 0x00, 0x6e, 0x00, 0x6c, 0x00, 0x6f, 0x00, 0x61, 0x00, 0x64, 0x00,
	0x00, 0x00, 0x42, 0x00, 0x00, 0x00, 0x01, 0x90, 0xb5, 0x00, 0x01, 0x00, 0x44, 0x00, 0x65, 0x00,
	0x69, 0x00, 0x6e, 0x00, 0x20, 0x00, 0x48, 0x00, 0x61, 0x00, 0x6e, 0x00, 0x64, 0x00, 0x62, 0x00,
	0x75, 0x00, 0x63, 0x00, 0x68, 0x00, 0x20, 0x00, 0x66, 0x00, 0xfc, 0x00, 0x72, 0x00, 0x20, 0x00,
	0x44, 0x00, 0x6f, 0x00, 0x77, 0x00, 0x6e, 0x00, 0x6c, 0x00, 0x6f, 0x00, 0x61, 0x00, 0x64, 0x00,
	0x73, 0x00, 0x00, 0x00, 0x44, 0x00, 0x00, 0x00, 0x01, 0xce, 0x01, 0x00, 0x01, 0x00, 0x54, 0x00,
	0x75, 0x00, 0x20, 0x00, 0x67, 0x00, 0x75, 0x00, 0xed, 0x00, 0x61, 0x00, 0x20, 0x00, 0x70, 0x00,
	0x61, 0x00, 0x72, 0x00, 0x61, 0x00, 0x20, 0x00, 0x68, 0x00, 0x61, 0x00, 0x63, 0x00, 0x65, 0x00,
	0x72, 0x00, 0x20, 0x00, 0x64, 0x00, 0x65, 0x00, 0x73, 0x00, 0x63, 0x00, 0x61, 0x00, 0x72, 0x00,
	0x67, 0x00, 0x61, 0x00, 0x73, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x01, 0xb9, 0x84, 0x00,
	0x01, 0x00, 0x4a, 0x00, 0x65, 0x00, 0x20, 0x00, 0x67, 0x00, 0x69, 0x00, 0x64, 0x00, 0x73, 0x00,
	0x20, 0x00, 0x76, 0x00, 0x6f, 0x00, 0x6f, 0x00, 0x72, 0x00, 0x20, 0x00, 0x64, 0x00, 0x6f, 0x00,
	0x77, 0x00, 0x6e, 0x00, 0x6c, 0x00, 0x6f, 0x00, 0x61, 0x00, 0x64, 0x00, 0x73, 0x00, 0x00, 0x00,
	0x42, 0x00, 0x00, 0x00, 0x01, 0xc1, 0xf2, 0x00, 0x01, 0x00, 0x47, 0x00, 0x75, 0x00, 0x69, 0x00,
	0x61, 0x00, 0x20, 0x00, 0x70, 0x00, 0x61, 0x00, 0x72, 0x00, 0x61, 0x00, 0x20, 0x00, 0x61, 0x00,
	0x73, 0x00, 0x20, 0x00, 0x74, 0x00, 0x72, 0x00, 0x61, 0x00, 0x6e, 0x00, 0x73, 0x00, 0x66, 0x00,
	0x65, 0x00, 0x72, 0x00, 0xea, 0x00, 0x6e, 0x00, 0x63, 0x00, 0x69, 0x00, 0x61, 0x00, 0x73, 0x00,
	0x00, 0x00, 0x4a, 0x00, 0x00, 0x00, 0x01, 0xca, 0xb3, 0x00, 0x01, 0x04, 0x18, 0x04, 0x3d, 0x04,
	0x41, 0x04, 0x42, 0x04, 0x40, 0x04, 0x43, 0x04, 0x3a, 0x04, 0x46, 0x04, 0x38, 0x04, 0x4f, 0x00,
	0x20, 0x04, 0x34, 0x04, 0x3b, 0x04, 0x4f, 0x00, 0x20, 0x04, 0x32, 0x04, 0x30, 0x04, 0x48, 0x04,
	0x38, 0x04, 0x45, 0x00, 0x20, 0x04, 0x41, 0x04, 0x3a, 0x04, 0x30, 0x04, 0x47, 0x04, 0x38, 0x04,
	0x32, 0x04, 0x30, 0x04, 0x3d, 0x04, 0x38, 0x04, 0x39, 0x00, 0x00, 0x00, 0x54, 0x00, 0x00, 0x00,
	0x05, 0x95, 0xc7, 0x00, 0x01, 0x00, 0x53, 0x00, 0x32, 0x00, 0x20, 0x00, 0x56, 0x00, 0x69, 0x00,
	0x64, 0x00, 0x65, 0x00, 0x6f, 0x00, 0x20, 0x00, 0x45, 0x00, 0x6e, 0x00, 0x63, 0x00, 0x6f, 0x00,
	0x64, 0x00, 0x65, 0x00, 0x72, 0x00, 0x20, 0x00, 0x53, 0x00, 0x74, 0x00, 0x75, 0x00, 0x64, 0x00,
	0x69, 0x00, 0x6f, 0x00, 0x20, 0x00, 0x76, 0x00, 0x65, 0x00, 0x72, 0x00, 0x73, 0x00, 0x69, 0x00,
	0x6f, 0x00, 0x6e, 0x00, 0x20, 0x00, 0x31, 0x00, 0x2e, 0x00, 0x33, 0x00, 0x34, 0x00, 0x00, 0x00,
	0x22, 0x00, 0x00, 0x0a, 0x04, 0x95, 0xc7, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xff, 0x80, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xd6, 0x4d, 0x54, 0x53, 0x4d, 0x00, 0x00, 0x00, 0x20, 0x4d, 0x54, 0x48,
	0x44, 0x00, 0x00, 0x00, 0x00, 0xc6, 0x42, 0x2a, 0x5c, 0xc6, 0x42, 0x2a, 0x5c, 0x00, 0x00, 0xff,
	0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x64, 0x69, 0x6e,
	0x66, 0x00, 0x00, 0x00, 0x1c, 0x64, 0x72, 0x65, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x0c, 0x75, 0x72, 0x6c, 0x20, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
	0x66, 0x73, 0x74, 0x73, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
	0x56, 0x50, 0x4e, 0x47, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x00,
	0x50, 0x00, 0x60, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x24, 0x4d, 0x44, 0x53, 0x54, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x57, 0x82, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x75, 0x75, 0x69, 0x64, 0x4d,
	0x54, 0x44, 0x54, 0x91, 0xbd, 0x84, 0xb7, 0x3f, 0x51, 0x44, 0x7a, 0x6e, 0xe3, 0x58, 0xd2, 0x00,
	0x00, 0x00, 0x56, 0x4d, 0x54, 0x44, 0x46, 0x00, 0x02, 0x00, 0x26, 0x00, 0x2d, 0x00, 0x02, 0x15,
	0xc7, 0x00, 0x01, 0x00, 0x53, 0x00, 0x6f, 0x00, 0x6e, 0x00, 0x79, 0x00, 0x4d, 0x00, 0x53, 0x00,
	0x50, 0x00, 0x72, 0x00, 0x69, 0x00, 0x76, 0x00, 0x61, 0x00, 0x74, 0x00, 0x65, 0x00, 0x00, 0x00,
	0x26, 0x00, 0x2d, 0x00, 0x01, 0x15, 0xc7, 0x00, 0x01, 0x00, 0x53, 0x00, 0x6f, 0x00, 0x6e, 0x00,
	0x79, 0x00, 0x4d, 0x00, 0x53, 0x00, 0x50, 0x00, 0x72, 0x00, 0x69, 0x00, 0x76, 0x00, 0x61, 0x00,
	0x74, 0x00, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x72, 0x4d, 0x54, 0x44, 0x54, 0x00, 0x02, 0x00,
	0x16, 0x00, 0x2d, 0x00, 0x02, 0x55, 0xc4, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x64, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x52, 0x00, 0x2d, 0x00, 0x01, 0x55, 0xc4, 0x00, 0x00, 0x0c,
	0x00, 0x00, 0x00, 0x64, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x49,
	0x4e, 0x41, 0x4d, 0x12, 0x00, 0x00, 0x00, 0x73, 0x00, 0x6d, 0x00, 0x61, 0x00, 0x6c, 0x00, 0x6c,
	0x00, 0x76, 0x00, 0x69, 0x00, 0x64, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x49, 0x43, 0x4d,
	0x54, 0x12, 0x00, 0x00, 0x00, 0x63, 0x00, 0x6f, 0x00, 0x6d, 0x00, 0x6d, 0x00, 0x65, 0x00, 0x6e,
	0x00, 0x74, 0x00, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x57, 0x9a, 0x75, 0x75, 0x69, 0x64, 0x4d,
	0x54, 0x53, 0x44, 0x21, 0xd2, 0x4f, 0xce, 0xbb, 0x88, 0x69, 0x5c, 0xfa, 0xc9, 0xc7, 0x40,
};

// Fake UID to identify Virtual MP4
#define FAKE_UID_XMB_VIDEO_ISO (FAKE_UID|0xD1)

// I/O related variables
static int file_pos = 0;
static SceUID video_dd = -1;
static SceUID isovideo_fd = -1;
static u8* icon_data = NULL;
static int icon_size = 0;
static char iso_launched[128] = {0};

// Controller data
extern SceCtrlData *last_control_data;

// Various important paths
static char* video_dir = "ms0:/VIDEO";
static char* isovideo_dir = "ms0:/ISO/VIDEO";
static const char* video_icon_path = "/UMD_VIDEO/ICON0.PNG";
static const char* music_icon_path = "/UMD_AUDIO/ICON0.PNG"; // does this even exist?

// Mount an ISO on XMB (reboots the system with Inferno driver instead of UMD)
static void launch_umdvideo_mount(const char *path) {

	int type = vshDetectDiscType(path);
	if (type < 0)
		return;

	sctrlSESetUmdFile(path);
	sctrlSESetBootConfFileIndex(BOOT_VSHUMD);
	sctrlSESetDiscType(type);
	sctrlKernelExitVSH(NULL);
}

// Get icon0.png size in a Video ISO
static void getIconStatFromISO(const char* isopath) {
	int res, size, lba;

	icon_size = 0;

	res = isoOpen(isopath);
	if (res<0) return;

	res = isoGetFileInfo(video_icon_path, (u32 *)&size, (u32 *)&lba);
	if (res<0) res = isoGetFileInfo(music_icon_path, (u32 *)&size, (u32 *)&lba); // retry with UMD_AUDIO
	isoClose();
	if (res<0) return;

	icon_size = size;
}

// Read icon0.png from a Video ISO
static void readIconFromISO(const char* isopath) {
	int res, size, lba;

	res = isoOpen(isopath);
	if (res<0) return;

	res = isoGetFileInfo(video_icon_path, (u32*)&size, (u32*)&lba);
	if (res<0) res = isoGetFileInfo(music_icon_path, (u32*)&size, (u32*)&lba); // retry with UMD_AUDIO
	if (res<0) {
		isoClose();
		return;
	}

	u8* data = vsh_malloc(size);

	res = isoRead(data, lba, 0, size);
	isoClose();

	if (res<0){
		vsh_free(data);
		return;
	}

	if (icon_data){
		vsh_free(icon_data);
	}

	icon_data = data;
	icon_size = size;

	// patch smallvid
	size += 24;
	smallvid[0x9DE] = icon_data[0x13]; // icon width
	smallvid[0x9E0] = icon_data[0x17]; // icon size
	smallvid[0xB1A] = (unsigned char)size; // size of png + size of tag (24)
	smallvid[0xB19] = (unsigned char)(size>>8);
	smallvid[0xA2E] = (unsigned char)icon_size; // size of png
	smallvid[0xA2D] = (unsigned char)(icon_size>>8);
	smallvid[0x6E2] = 0; // nullify titles so it uses filename instead
	smallvid[0x71C] = 0;
	smallvid[0x770] = 0;
	smallvid[0x7AC] = 0;
	smallvid[0x7EE] = 0;
	smallvid[0x832] = 0;
	smallvid[0x86A] = 0;
	smallvid[0x8AB] = 0;
	smallvid[0x8AC] = 0;
	smallvid[0x8AD] = 0;
}

static int user_input() {
	if (last_control_data) {
		u32 swap_xo;
		u32 pad = last_control_data->Buttons;
		vctrlGetRegistryValue("/CONFIG/SYSTEM/XMB", "button_assign", &swap_xo);
		// detect that some button has been pressed, user will have pressed any of these when wanting to play the file
		if(  ( ((pad&PSP_CTRL_CROSS)  == PSP_CTRL_CROSS) && swap_xo)
		  || ( ((pad&PSP_CTRL_CIRCLE) == PSP_CTRL_CIRCLE) && !swap_xo)
		  ||    (pad&PSP_CTRL_START)  == PSP_CTRL_START
		  ||    (pad&PSP_CTRL_RIGHT)  == PSP_CTRL_RIGHT
		){
			return 1;
		}
	}
	return 0;
}

int videoMpegCreate(void* Mpeg, void* pData, int iSize, void* Ringbuffer, int iFrameWidth, int iUnk1, int iUnk2) {
	if (iso_launched[0]) {
		launch_umdvideo_mount(iso_launched); // launch ISO file
	}

	// passthrough
	int (*_sceMpegCreate)(void* Mpeg, void* pData, int iSize, void* Ringbuffer, int iFrameWidth, int iUnk1, int iUnk2);
	_sceMpegCreate = (void *)sctrlHENFindFunction("sceMpegVsh_library", "sceMpeg", 0xD8C5F121);
	if (!_sceMpegCreate) _sceMpegCreate = (void *)sctrlHENFindFunction("sceMpeg_library", "sceMpeg", 0xD8C5F121);

	return _sceMpegCreate(Mpeg, pData, iSize, Ringbuffer, iFrameWidth, iUnk1, iUnk2);
}

// sceIoOpen for Video ISO
SceUID videoIoOpen(const char* file, u32 flags, u32 mode) {
	SceUID res = sceIoOpen(file, flags, mode); // passthrough

	if (res < 0) { // failed, retry with ISO
		int k1 = pspSdkSetK1(0);
		char isopath[128]; strcpy(isopath, isovideo_dir);
		isopath[0] = file[0]; isopath[1] = file[1]; // adjust device (psp go)
		char* filename = strrchr(file, '/');
		if (filename) { // filename found
			strcat(isopath, filename); // redirect to /ISO/VIDEO/
			char* ext = strstr(isopath, ".mp4");
			if (ext) { // .mp4 extension found
				SceIoStat stat;
				strcpy(ext, ".iso"); // replace .mp4 with .iso
				if (sceIoGetstat(isopath, &stat)>=0) { // ISO file exists
					res = FAKE_UID_XMB_VIDEO_ISO; // adjust error value with fake uid
					file_pos = 0; // reset file position
					iso_launched[0] = 0;
					// super nasty solution for detecting that you are trying to play a Video ISO file
					if (user_input()) {
						strcpy(iso_launched, isopath); // remember ISO file
					}
					// read icon0.png from the ISO to make it viable in the XMB
					readIconFromISO(isopath);
				}
			}
		}
		pspSdkSetK1(k1);
	}

	return res;
}

// sceIoDopen for Video ISO
SceUID videoIoDopen(const char* dir) {
	SceUID res = sceIoDopen(dir);

	video_dir[0] = dir[0]; // adjust device (psp go)
	video_dir[1] = dir[1];
	if (strcasecmp(dir, video_dir) == 0) { // check if /VIDEO/ folder has been opened
		video_dd = res;
		int k1 = pspSdkSetK1(0);
		isovideo_dir[0] = dir[0]; // adjust device (psp go)
		isovideo_dir[1] = dir[1];
		isovideo_fd = sceIoDopen(isovideo_dir); // open /ISO/VIDEO/ folder too
		pspSdkSetK1(k1);
	}

	return res;
}

// sceIoGetstat for Video ISO
int videoIoGetstat(const char* path, SceIoStat* stat) {
	int res = sceIoGetstat(path, stat);

	if (res < 0) { // failed, retry
		int k1 = pspSdkSetK1(0);
		char isopath[128]; strcpy(isopath, isovideo_dir); // retry with /ISO/VIDEO/
		isopath[0] = path[0]; isopath[1] = path[1]; // adjust device (psp go)
		char* filename = strrchr(path, '/');
		if (filename) { // file name found
			strcat(isopath, filename);
			char* ext = strstr(isopath, ".mp4");
			if (ext) { // .mp4 extension found
				strcpy(ext, ".iso"); // retry with .iso
				res = sceIoGetstat(isopath, stat);
				if (res>=0) { // ISO file found
					getIconStatFromISO(isopath); // get size of ISO's icon0.png
					stat->st_size = sizeof(smallvid) + icon_size; // adjust virtual mp4 file size
				}
			}
		}
		pspSdkSetK1(k1);
	}

	return res;
}

// sceIoRead for Video ISO
int videoIoRead(SceUID fd, void* buf, u32 size) {
	if (fd == FAKE_UID_XMB_VIDEO_ISO) { // Fake UID of Virtual MP4 file
		if (file_pos >= sizeof(smallvid)+icon_size) // Out of Bouds read
			return 0;
		if (file_pos+size > sizeof(smallvid)+icon_size) // more data requested than available
			size = sizeof(smallvid)+icon_size - file_pos;

		if (file_pos < sizeof(smallvid)) { // current position is within mp4 header
			if (file_pos+size > sizeof(smallvid)){ // data to be read is split between mp4 header and png icon
				int size_1 = sizeof(smallvid)-file_pos; // calculate how much from mp4 header to read
				int size_2 = file_pos+size-sizeof(smallvid); // calculate how much from png to read
				memcpy(buf, &smallvid[file_pos], size_1); // read from mp4 header
				memcpy((u8*)buf+size_1, icon_data, size_2); // read from png icon
			} else { // only mp4 header needs to be read
				memcpy(buf, &smallvid[file_pos], size);
			}
		} else { // only png icon needs to be read
			memcpy(buf, &icon_data[file_pos-sizeof(smallvid)], size);
		}

		file_pos += size; // adjust virtual file position
		return size;
	}

	return sceIoRead(fd, buf, size);
}

// sceIoDread for Video ISO
int videoIoDread(SceUID fd, SceIoDirent *dir) {
	int res = sceIoDread(fd, dir);

	if (res == 0) { // no more items being read in /VIDEO/ folder
		int k1 = pspSdkSetK1(0);
		res = sceIoDread(isovideo_fd, dir); // continue reading items from /ISO/VIDEO/
		if (res>0 && dir->d_name[0] != '.') { // got valid item
			char* ext = strrchr(dir->d_name, '.');
			if (ext) strcpy(ext, ".mp4"); // replace extension with .mp4
			if (dir->d_private) { // adjust private dirent data
				pspMsPrivateDirent *pri_dirent = dir->d_private;
				ext = strrchr(pri_dirent->l_name, '.'); // long file name
				if (ext) strcpy(ext, ".mp4"); // change extension to .mp4
				ext = strrchr(pri_dirent->s_name, '.'); // short file name
				if (ext) strcpy(ext, ".MP4"); // change extension to .MP4
			}
		}
		pspSdkSetK1(k1);
	}

	return res;
}

// sceIoClose for Video ISO
int videoIoClose(SceUID fd) {
	if (fd != FAKE_UID_XMB_VIDEO_ISO)
		return sceIoClose(fd);

	file_pos = 0; // reset file position
	iso_launched[0] = 0;

	// free icon data
	if (icon_data) {
		vsh_free(icon_data);
		icon_data = 0;
		icon_size = 0;
	}

	return 0;
}

// sceIoDclose for Video ISO
int videoIoDclose(SceUID fd) {
	int res = sceIoDclose(fd);
	if (fd == video_dd){ // when closing /VIDEO/, close /ISO/VIDEO/ too
		int k1 = pspSdkSetK1(0);
		sceIoDclose(isovideo_fd);
		pspSdkSetK1(k1);
		video_dd = -1;
		isovideo_fd = -1;
	}
	return res;
}

// sceIoLseek for Video ISO
SceOff videoIoLseek(SceUID fd, SceOff offset, int whence) {
	if (fd != FAKE_UID_XMB_VIDEO_ISO) return sceIoLseek(fd, offset, whence);
	switch (whence) { // adjust virtual mp4 file position
		case PSP_SEEK_SET: file_pos = offset; break;
		case PSP_SEEK_CUR: file_pos += offset; break;
		case PSP_SEEK_END: file_pos = icon_size+sizeof(smallvid)-offset; break;
	}
	return file_pos;
}

// sceIoRemove for Video ISO
int videoIoRemove(const char * file) {
	int res = sceIoRemove(file);

	if (res<0) { // failed, retry with Video ISO
		int k1 = pspSdkSetK1(0);
		char* filename;
		char path[256];
		// redirect file to /ISO/VIDEO/ folder
		isovideo_dir[0] = file[0]; isovideo_dir[1] = file[1]; // redirect device (psp go)
		strcpy(path, isovideo_dir);
		filename = strrchr(file, '/'); // find file name
		if (filename) strcat(path, filename);
		// find .mp4 extension
		filename = strstr(path, ".mp4");
		// replace with .iso
		if (filename) strcpy(filename, ".iso");
		// retry sceIoRemove
		res = sceIoRemove(path);
		pspSdkSetK1(k1);

		extern char mounted_iso[];
		if (res >= 0 && strcasecmp(mounted_iso, path) == 0) {
			sctrlKernelExitVSH(NULL); // trigger reboot if we have deleted the currently mounted ISO
		}
	}

	return res;
}

// determine if a given path is from /VIDEO/ folder
int is_video_path(const char* path) {
	video_dir[0] = path[0]; video_dir[1] = path[1];
	return strncasecmp(path, video_dir, 10) == 0;
}

// determine if an opened file is a Virtual MP4
int is_video_file(SceUID fd) {
	return fd == FAKE_UID_XMB_VIDEO_ISO;
}

// determine if an opened folder is /VIDEO/
int is_video_folder(SceUID dd) {
	return dd == video_dd;
}
